# Tools

Utility scripts for the ModernBERT project.

## merge_mds_subsets.py

Merge multiple MDS datasets into unified train/val/train_small splits with automatic download from Hugging Face.

### Features

- ✅ Auto-download from Hugging Face repositories
- ✅ Merge from local directories
- ✅ Automatic train/val/train_small splitting
- ✅ Symlinks or file copying (auto-fallback on Windows)
- ✅ Train_small-only mode for quick testing

### Requirements

```bash
pip install tqdm huggingface_hub
```

### Usage Examples

**1. Download and merge from Hugging Face:**

```bash
python tools/merge_mds_subsets.py \
  --hf_repos QuangDuy/FineWiki-mds-tokenized-1024 \
  --output_dir ./data \
  ---decompress \
  --train_ratio 0.9 \
  --val_ratio 0.1 \
  --train_small_ratio 0.05
```

**2. Merge from local directories:**

```bash
python tools/merge_mds_subsets.py \
  --source_dir ./source_data \
  --datasets FineWeb2-vie-mds FineWiki-mds \
  --output_dir ./data
```

**3. Quick test dataset (train_small only):**

```bash
python tools/merge_mds_subsets.py \
  --hf_repos QuangDuy/FineWiki-mds \
  --output_dir ./data \
  --only-train-small \
  --train_small_ratio 0.01
```

### Key Arguments

- `--hf_repos`: Hugging Face repository IDs to download
- `--source_dir`: Local directory containing datasets
- `--datasets`: Dataset folder names to merge (for local mode)
- `--output_dir`: Output directory for merged data
- `--train_ratio`: Training data ratio (default: 0.9)
- `--val_ratio`: Validation data ratio (default: 0.1)
- `--train_small_ratio`: Train_small ratio (default: 0.05)
- `--hf_token`: Hugging Face token for private repos
- `--hf_cache_dir`: Custom cache directory
- `--no-symlinks`: Copy files instead of symlinks
- `--only-train-small`: Create only train_small split
- `--seed`: Random seed for reproducibility (default: 42)

### Output Structure

```
output_dir/
├── train/          # Training split
│   ├── index.json
│   └── shard.*.mds
├── val/            # Validation split
│   ├── index.json
│   └── shard.*.mds
└── train_small/    # Quick testing split
    ├── index.json
    └── shard.*.mds
```

### Troubleshooting

- **Windows symlink errors**: Script auto-fallbacks to copy mode or use `--no-symlinks`
- **Private repos**: Use `--hf_token` with token from https://huggingface.co/settings/tokens
- **Ratio errors**: Ensure `train_ratio + val_ratio = 1.0`

## count_params.py

Count parameters in a model configuration.

### Usage (PowerShell)

```powershell
# For flex-bert-vi-base
(Get-Content yamls\main\flex-bert-vi-base.yaml) `
  -replace 'sliding_window:\s*\d+', 'sliding_window: -1' `
  -replace 'global_attn_every_n_layers:\s*\d+', 'global_attn_every_n_layers: -1' `
  -replace 'loss_function:\s*fa_cross_entropy', 'loss_function: cross_entropy' `
| Set-Content yamls\main\flex-bert-vi-base.count.yaml

python .\tools\count_params.py --dir yamls\main --pattern flex-bert-vi-base.count.yaml --tokenizer tokenizer\huit-bert --summary
```

```powershell
# For flex-bert-base
(Get-Content yamls\main\flex-bert-vi-base.yaml) `
  -replace 'sliding_window:\s*\d+', 'sliding_window: -1' `
  -replace 'global_attn_every_n_layers:\s*\d+', 'global_attn_every_n_layers: -1' `
  -replace 'loss_function:\s*fa_cross_entropy', 'loss_function: cross_entropy' `
| Set-Content yamls\main\flex-bert-vi-base.count.yaml

python .\tools\count_params.py --dir yamls\main --pattern flex-bert-vi-base.count.yaml --tokenizer tokenizer\huit-bert --summary
```